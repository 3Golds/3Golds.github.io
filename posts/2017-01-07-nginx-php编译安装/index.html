<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Nginx&#43;PHP编译安装 :: 赵鑫的博客</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="编译安装 Nginx&amp;amp;PHP nginx 编译安装 下载路径：(建议使用Tengine) http://nginx.org/ http://tengine.taobao.org/
启动命令 /usr/local/nginx/sbin/nginx 重载 nginx /usr/local/nginx/sbin/nginx -s reload
一、安装环境 sudo yum groupinstall &amp;quot;Development Tools&amp;quot; -y sudo yum install jemalloc-devel openssl-devel pcre-devel -y nginx编译参数(红色部分可能不支持,可去掉) # sudo ./configure --prefix=/usr/local/nginx --user=webapps --group=webapps --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-jemalloc # sudo make # sudo make install # cd /usr/local/nginx # sudo mv logs /export/ # sudo ln -s /export/logs logs # cd /usr/local/nginx/conf # sudo mkdir vhosts  二、修改 conf 文件 1."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://zhaox.xyz/posts/2017-01-07-nginx-php%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" />





<link rel="stylesheet" href="https://zhaox.xyz/assets/style.css">


<link rel="stylesheet" href="https://zhaox.xyz/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhaox.xyz/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://zhaox.xyz/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nginx&#43;PHP编译安装"/>
<meta name="twitter:description" content="`nginx`和`php`编译安装"/>



<meta property="og:title" content="Nginx&#43;PHP编译安装" />
<meta property="og:description" content="`nginx`和`php`编译安装" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhaox.xyz/posts/2017-01-07-nginx-php%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" />
<meta property="article:published_time" content="2017-01-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-01-07T00:00:00+00:00" /><meta property="og:site_name" content="赵鑫的博客" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">赵鑫的博客</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://zhaox.xyz/posts/2017-01-07-nginx-php%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">Nginx+PHP编译安装</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2017-01-07
        </span>
      
      <span class="post-author">— Written by zhaoxin</span>
      
        <span class="post-read-time">— 3 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://zhaox.xyz/tags/nginx/">nginx</a>&nbsp;
        
          #<a href="https://zhaox.xyz/tags/php/">php</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<h3 id="编译安装-nginx-php">编译安装 Nginx&amp;PHP</h3>

<h4 id="nginx-编译安装"><strong>nginx 编译安装</strong></h4>

<p><strong>下载路径</strong>：(建议使用<code>Tengine</code>)
<a href="http://nginx.org/">http://nginx.org/</a>
<a href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></p>

<p><strong>启动命令</strong> /usr/local/nginx/sbin/nginx
<strong>重载 nginx</strong> /usr/local/nginx/sbin/nginx -s reload</p>

<h5 id="一-安装环境">一、安装环境</h5>

<pre><code>sudo yum groupinstall &quot;Development Tools&quot; -y
sudo yum install jemalloc-devel openssl-devel pcre-devel -y

nginx编译参数(红色部分可能不支持,可去掉)
# sudo ./configure --prefix=/usr/local/nginx --user=webapps --group=webapps --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-jemalloc
# sudo make
# sudo make install
# cd /usr/local/nginx
# sudo mv logs /export/
# sudo ln -s /export/logs logs
# cd /usr/local/nginx/conf
# sudo mkdir vhosts
</code></pre>

<h4 id="二-修改-conf-文件">二、修改 conf 文件</h4>

<p><strong>1. 修改主 nginx.conf</strong>
1-1. 开启 log_format
1-2. 在 http 上下文结尾增加 include vhosts/*;
1-3. 需要注意 nginx 配置文件是按顺序读取
1-5.修改 nginx worker 用户为 webapps
1-6.修改/etc/security/limits.conf</p>

<pre><code># vim /usr/local/nginx/conf/nginx.conf
user  webapps;
worker_processes  2;
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;
worker_rlimit_nofile 655350;
events {
    use epoll;
    worker_connections  1024;
}
# load modules compiled as Dynamic Shared Object (DSO)
#
#dso {
#    load ngx_http_fastcgi_module.so;
#    load ngx_http_rewrite_module.so;
#}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  localhost;
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
include vhosts/*;
}
</code></pre>

<p><strong>2. 修改自定义配置文件</strong></p>

<h5 id="修改配置文件-usr-local-nginx-conf-vhosts-host-conf"><strong>修改配置文件<code>/usr/local/nginx/conf/vhosts/host.conf</code></strong></h5>

<pre><code>server {
        listen       80;
        server_name  www.fraudect.com;
        #charset koi8-r;
	access_log  logs/www.fraudect.com.access.log;
        error_log       logs/www.fraudect.com.error.log;
	location / {
            root        /export/webapps/www.fraudect.com;
	    index	index.php;
	}

	location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ {
            	root        /export/webapps/www.fraudect.com;
    		expires      3d;
    	}
	location ~ \.php$ {
                fastcgi_pass     127.0.0.1:9000;
                fastcgi_index    index.php;
		fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
                include          fastcgi_params;
                fastcgi_connect_timeout    300;
                fastcgi_send_timeout       300;
                fastcgi_read_timeout       300;
		fastcgi_buffers 8 256k;
      		fastcgi_buffer_size 256k;
      		fastcgi_busy_buffers_size 256k;
		fastcgi_intercept_errors on;
        }
}

</code></pre>

<h4 id="若跳转-php-用此部分"><strong>若跳转<code>php</code>用此部分</strong></h4>

<pre><code>	location ~ \.php$ {
                fastcgi_pass     127.0.0.1:9000;
                fastcgi_index    index.php;
				fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
                include          fastcgi_params;
                fastcgi_connect_timeout    300;
                fastcgi_send_timeout       300;
                fastcgi_read_timeout       300;
				fastcgi_buffers 8 256k;
	      		fastcgi_buffer_size 256k;
	      		fastcgi_busy_buffers_size 256k;
				fastcgi_intercept_errors on;
        }

</code></pre>

<h4 id="若跳转-java-走此部分"><strong>若跳转<code>java</code>走此部分</strong></h4>

<pre><code>location / {
	proxy_pass http://10.100.10.20:8080;

#	proxy_pass http://axis.prd.pzoom.com;

	proxy_max_temp_file_size 0;
	proxy_set_header   Host             $host;
	proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_buffers 256 4k;
    proxy_connect_timeout 600;
    proxy_read_timeout 600;
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 301 1h;
    proxy_cache_valid any 1m;
	proxy_intercept_errors on;

}
</code></pre>

<h4 id="upstream-conf-文件"><strong><code>upstream.conf</code> 文件</strong></h4>

<pre><code>upstream fcgi {
#upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。
server 192.168.80.121:80 weight=3;
server 192.168.80.122:80 weight=2;
server 192.168.80.123:80 weight=3;
}
</code></pre>

<h4 id="usr-local-nginx-conf-fastcgi-params-文件"><strong><code>/usr/local/nginx/conf/fastcgi_params</code> 文件</strong></h4>

<pre><code>fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
fastcgi_param  SERVER_SOFTWARE    nginx;
fastcgi_param  QUERY_STRING       $query_string;
fastcgi_param  REQUEST_METHOD     $request_method;
fastcgi_param  CONTENT_TYPE       $content_type;
fastcgi_param  CONTENT_LENGTH     $content_length;
fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
fastcgi_param  REQUEST_URI        $request_uri;
fastcgi_param  DOCUMENT_URI       $document_uri;
fastcgi_param  DOCUMENT_ROOT      $document_root;
fastcgi_param  SERVER_PROTOCOL    $server_protocol;
fastcgi_param  REMOTE_ADDR        $remote_addr;
fastcgi_param  REMOTE_PORT        $remote_port;
fastcgi_param  SERVER_ADDR        $server_addr;
fastcgi_param  SERVER_PORT        $server_port;
fastcgi_param  SERVER_NAME        $server_name;
</code></pre>

<p><strong>补充内容</strong></p>

<pre><code>####### 这个是一个thinkphp框架的伪静态规则，请忽略
if (!-e $request_filename) {
rewrite  ^(.*)$  /index.php last;
break;
</code></pre>

<p>###<strong>php 构建部分</strong>
<code>centos 6.X</code> <code>php-fpm方式</code></p>

<h4 id="一-依赖关系安装"><strong>一、依赖关系安装</strong></h4>

<pre><code># sudo yum install libmcrypt-devel ncurses-devel recode-devel aspell-devel curl-devel readline-devel openldap-devel enchant-devel pcre-devel net-snmp-devel libicu-devel libtool-ltdl-devel libjpeg-devel libpng-devel libxml2-devel bzip2-devel freetype-devel gcc-c++
# sudo cp -p /usr/lib64/libldap* /usr/lib
# sudo yum install mysql-devel
# sudo ln -s /usr/lib64/mysql /usr/lib/mysql
</code></pre>

<p><strong>php 编译参数(如果 make 报 ld 之类的错误，尝试移除 ldap 和 lntl 编译模块)</strong>
<strong>下载链接地址</strong>：<a href="http://docs.php.net/distributions/php-5.6.24.tar.bz2">http://docs.php.net/distributions/php-5.6.24.tar.bz2</a></p>

<pre><code># sudo tar xf php-5.6.24.tar.bz2
# sudo ./configure --prefix=/usr/local/php  --with-config-file-path=/usr/local/php/etc --with-config-file-scan-dir=/usr/local/php/etc/php.d --with-curl --with-mysql=mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir  --with-gd --with-libxml-dir --with-zlib --with-mcrypt --with-bz2 --enable-sysvshm --enable-sysvsem --enable-soap --with-recode --with-snmp --with-readline  --enable-intl --enable-dba --enable-bcmath --with-enchant --with-pspell --enable-xml --enable-sockets  --enable-exif --enable-inline-optimization --enable-fpm
</code></pre>

<h4 id="apache-专用">apache 专用</h4>

<p><code>--with-apxs2=/usr/sbin/apxs</code></p>

<h4 id="ubuntu">ubuntu</h4>

<pre><code>apt-get -y install  libpspell-dev build-essential libcurl3-openssl-dev libbz2-dev libenchant-dev libxml2-dev libjpeg-dev libpng-dev libfreetype6-dev libicu-dev libmcrypt-dev libncurses5-dev  librecode-dev libaspell-dev libreadline-dev
</code></pre>

<h5 id="若-apache-添加参数-with-apxs2-usr-sbin-apxs-apxs-是-apache-的-httpd-devel-安装后生成的-yum-安装后路径一般是-usr-sbin-apxs-如果是编译安装-一般位于-apache-的-bin-目录下">若 apache 添加参数 &ndash;with-apxs2=/usr/sbin/apxs apxs 是 apache 的 httpd-devel 安装后生成的，yum 安装后路径一般是/usr/sbin/apxs，如果是编译安装，一般位于 apache 的 bin 目录下</h5>

<h4 id="php-fpm-启动脚本"><strong>php-fpm 启动脚本</strong></h4>

<p><strong><code>php源码包根目录</code></strong></p>

<pre><code># sudo cp sapi/fpm/init.d.php-fpm /etc/rc.d/init.d/php-fpm
# sudo chkconfig --add php-fpm
# sudo chkconfig php-fpm on
# sudo chmod u+x /etc/rc.d/init.d/php-fpm
# sudo cp php.ini-production /usr/local/php/etc/php.ini

# sudo cd /usr/local/php/var
# sudo rm -rf log
# sudo ln -s /export/logs log
</code></pre>

<h4 id="修改启动脚本"><strong>修改启动脚本</strong></h4>

<p>脚本前几行注释结束后的首行部位加入<code>[ -f /etc/rc.d/init.d/functions ] &amp;&amp; . /etc/rc.d/init.d/functions</code></p>

<p>在 start 函数的首行加入 daemon</p>

<pre><code>case $1 in
    start)
    	$php_fpm_BIN --daemonize $php_opts
</code></pre>

<p><strong>*修改 php.ini 这一步骤需要根据开发来决定开启额外模块或者参数</strong></p>

<h4 id="修改-php-fpm-ini-相当于-apache-的配置文件"><strong>修改<code>php-fpm.ini</code> ==&gt;相当于 apache 的配置文件</strong></h4>

<pre><code>#vi /usr/local/php/etc/php-fpm.conf
[global]
log_level = notice
daemonize = yes
events.mechanism = epoll
rlimit_files = 10240
emergency_restart_threshold = 60
emergency_restart_interval = 60s
[fcgi]
user = webapps
group = webapps
listen = 0.0.0.0:9000
pm = static
pm.max_children = 200
pm.max_requests = 1024
</code></pre>

<blockquote>
<p>作者：Antony WX&amp;QQ：1257465991
Q/A：如有问题请慷慨提出</p>
</blockquote>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="https://zhaox.xyz/posts/2017-01-07-linux%E7%94%A8%E6%88%B7%E7%94%A8%E6%88%B7%E7%BB%84%E5%8F%8A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">
                <span class="button__icon">←</span>
                <span class="button__text">Linux用户、用户组及权限管理</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="https://zhaox.xyz/posts/ansible%E8%84%9A%E6%9C%AC/">
                <span class="button__text">ansible脚本</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">赵鑫的博客</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2019 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://zhaox.xyz/assets/main.js"></script>
<script src="https://zhaox.xyz/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
